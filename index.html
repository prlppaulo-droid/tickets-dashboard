function exportHtmlForSelection(){
  if (!RAW.data.length){ alert("Primero importe un CSV."); return; }

  const built = buildPayloadForSelection();
  if (!built) return;

  const { titleSuffix, payload } = built;
  const base = document.documentElement.outerHTML;

  const injected = base.replace(
    "</body>",
    `<script>window.__EMBEDDED_PAYLOAD__=${safeJsonStringify(payload)};<\\/script>
     <script>
       (function(){
         const p = window.__EMBEDDED_PAYLOAD__;
         RAW={headers:p.headers,data:p.data};
         LAST_FILE_NAME = p.meta.sourceFile || "CSV";
         document.getElementById("fileInfo").textContent =
           (p.meta.sourceFile||"CSV")+" • "+p.meta.totalRows+" filas (embebido)";
         document.getElementById("ownerSelect").value="__ALL__";
         renderOwnerSelect(RAW.data, detectColumns(RAW.headers));
         applyFilterAndRender();
         document.title = "Reporte Tickets - " + (p.meta.selection==="__ALL__" ? "General" : p.meta.selection);
         setStatus("Embebido ✅");
       })();
     <\\/script><\\/body>`
  );

  const blob = new Blob([injected], { type: "text/html;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `reporte_tickets_${titleSuffix.replace(/[^a-z0-9]+/gi,"_")}.html`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}

function exportPdfForSelection(){
  if (!RAW.data.length){ alert("Primero importe un CSV."); return; }

  const built = buildPayloadForSelection();
  if (!built) return;

  const { payload } = built;
  const base = document.documentElement.outerHTML;

  const injected = base.replace(
    "</body>",
    `<script>window.__EMBEDDED_PAYLOAD__=${safeJsonStringify(payload)};<\\/script>
     <script>
       (function(){
         const p = window.__EMBEDDED_PAYLOAD__;
         RAW={headers:p.headers,data:p.data};
         LAST_FILE_NAME = p.meta.sourceFile || "CSV";
         document.getElementById("fileInfo").textContent =
           (p.meta.sourceFile||"CSV")+" • "+p.meta.totalRows+" filas (embebido)";
         document.getElementById("ownerSelect").value="__ALL__";
         renderOwnerSelect(RAW.data, detectColumns(RAW.headers));
         applyFilterAndRender();
         document.title = "Reporte Tickets - " + (p.meta.selection==="__ALL__" ? "General" : p.meta.selection);
         setStatus("Embebido ✅");
         setTimeout(()=>window.print(), 900);
       })();
     <\\/script><\\/body>`
  );

  const blob = new Blob([injected], { type: "text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const w = window.open(url, "_blank");
  if(!w){
    alert("Pop-up bloqueado. Permita pop-ups para exportar PDF.");
    return;
  }
  setTimeout(()=>URL.revokeObjectURL(url), 10000);
}
